<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>도시별 Twilight-inclusive Brightness 히트맵</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #000;
      color: #eee;
    }

    header {
      padding: 16px 24px 10px;
      background: #000;
      border-bottom: 1px solid #222;
      position: sticky;
      top: 0;
      z-index: 10;
      text-align: center; /* 상단 중앙 정렬 */
    }

    h1 {
      margin: 0 0 6px;
      font-size: 22px;
    }

    .subtitle {
      margin: 0;
      font-size: 13px;
      color: #aaa;
    }

    .city-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center; /* 버튼 중앙 정렬 */
      gap: 8px;
      margin-top: 10px;
    }

    .city-button {
      border: 1px solid #444;
      background: #111;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      color: #ddd;
      transition: 0.15s;
    }

    .city-button:hover {
      background: #222;
    }

    .city-button.active {
      background: #f4b860;
      color: #000;
      border-color: #f4b860;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .main-map-card {
      background: #050608;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
      padding: 12px 16px 18px;
      margin-bottom: 18px;
      border: 1px solid #222;
    }

    .main-map-title {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 8px;
      color: #f5f5f5;
      text-align: center;
    }

    .main-map-layout {
      display: flex;
      gap: 12px;
      align-items: stretch;
    }

    #main-heatmap {
      flex: 1;
      height: 420px;
      border-radius: 8px;
      display: block;
      background: #000;
    }

    .colorbar {
      width: 70px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      color: #ddd;
      font-size: 10px;
    }

    #colorbar {
      width: 26px;
      height: 220px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #000;
      display: block;
    }

    .colorbar-ticks {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .colorbar-ticks div {
      font-size: 10px;
      color: #ccc;
    }

    .colorbar-label {
      text-align: center;
      margin-top: 4px;
      font-size: 10px;
      line-height: 1.4;
      color: #ccc;
    }

    .mini-section-title {
      font-size: 14px;
      font-weight: 600;
      margin: 10px 2px 6px;
      color: #eee;
    }

    .mini-maps-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 24px;
    }

    .mini-card {
      background: #050608;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
      overflow: hidden;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      transition: 0.15s;
      border: 1px solid #222;
    }

    .mini-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.9);
    }

    .mini-title {
      font-size: 12px;
      font-weight: 600;
      padding: 6px 8px;
      border-bottom: 1px solid #222;
      background: #07080d;
      color: #ddd;
    }

    .mini-heatmap {
      flex: 1;
      min-height: 120px;
      display: block;
      background: #000;
    }

    .mini-card.hidden-mini {
      display: none;
    }

    /* hover tooltip 스타일 */
    #heatmap-tooltip {
      position: fixed;
      pointer-events: none;
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 6px 10px;
      font-size: 11px;
      border-radius: 6px;
      border: 1px solid #444;
      z-index: 99999;
      opacity: 0;
      transition: opacity 0.1s ease;
      white-space: pre;
    }

    @media (max-width: 900px) {
      #main-heatmap {
        height: 340px;
      }
      .mini-maps-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .main-map-layout {
        flex-direction: column;
        align-items: center;
      }
      #colorbar {
        height: 180px;
      }
    }

    @media (max-width: 600px) {
      header { position: static; }
      .mini-maps-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>도시별 Twilight-inclusive Brightness 히트맵</h1>
    <p class="subtitle">
      X축: 24시간(30분 간격), Y축: 2024-12-01 → 2025-11-30, 색: brightness_twilight (0=밤, 1=한낮)
    </p>

    <div class="city-buttons" id="city-buttons"></div>
  </header>

  <main>
    <section class="main-map-card">
      <div class="main-map-title" id="main-map-title">도시 히트맵</div>

      <div class="main-map-layout">
        <canvas id="main-heatmap"></canvas>

        <div class="colorbar">
          <canvas id="colorbar"></canvas>
          <div class="colorbar-ticks">
            <div>1.0</div>
            <div>0.5</div>
            <div>0.0</div>
          </div>
          <div class="colorbar-label">
            Brightness (Sun altitude &gt; -6°, incl. twilight)
          </div>
        </div>
      </div>
    </section>

    <section>
      <div class="mini-section-title">다른 도시 미니 히트맵 (클릭 시 위로 크게 보기)</div>
      <div class="mini-maps-grid" id="mini-maps-grid"></div>
    </section>
  </main>

  <!-- hover용 tooltip 요소 (스크립트보다 위에 있어야 함!) -->
  <div id="heatmap-tooltip"></div>

  <!-- 1) 엑셀에서 변환한 데이터 파일 -->
  <script src="brightness_data.js"></script>

  <!-- 2) 메인 스크립트 -->
  <script>
    if (!window.BRIGHTNESS_DATA) {
      alert("brightness_data.js 를 찾을 수 없습니다. 파이썬 스크립트로 먼저 생성해 주세요.");
    }

    // 도시 id -> 한국어 라벨
    const CITY_LABELS = {
      seoul: "서울",
      tokyo: "도쿄",
      oslo: "오슬로",
      stockholm: "스톡홀름",
      helsinki: "헬싱키",
      reykjavik: "레이캬비크",
      longyearbyen: "롱이어비엔",
      new_york: "뉴욕",
      sao_paulo: "상파울루",
      cape_town: "케이프타운"
    };

    // 표시 순서
    const CITY_ORDER = [
      "seoul",
      "tokyo",
      "oslo",
      "stockholm",
      "helsinki",
      "reykjavik",
      "longyearbyen",
      "new_york",
      "sao_paulo",
      "cape_town"
    ].filter(id => window.BRIGHTNESS_DATA[id]);

    // 0~1 brightness -> red/orange 계열 색으로 매핑
    const COLOR_STOPS = [
      { v: 0.0,  rgb: [3, 0, 0] },       // 아주 어두운 붉은 톤
      { v: 0.2,  rgb: [30, 5, 2] },      // 어두운 적갈색
      { v: 0.4,  rgb: [110, 30, 10] },   // 붉은 주황
      { v: 0.6,  rgb: [190, 70, 20] },   // 주황
      { v: 0.8,  rgb: [240, 135, 50] },  // 밝은 주황
      { v: 1.0,  rgb: [255, 232, 185] }  // 밝은 아이보리
    ];

    function brightnessToColor(value) {
      const v = Math.max(0, Math.min(1, value || 0));

      let lower = COLOR_STOPS[0];
      let upper = COLOR_STOPS[COLOR_STOPS.length - 1];

      for (let i = 0; i < COLOR_STOPS.length - 1; i++) {
        const a = COLOR_STOPS[i];
        const b = COLOR_STOPS[i + 1];
        if (v >= a.v && v <= b.v) {
          lower = a;
          upper = b;
          break;
        }
      }

      const t = (v - lower.v) / (upper.v - lower.v || 1);
      const r = Math.round(lower.rgb[0] + (upper.rgb[0] - lower.rgb[0]) * t);
      const g = Math.round(lower.rgb[1] + (upper.rgb[1] - lower.rgb[1]) * t);
      const b = Math.round(lower.rgb[2] + (upper.rgb[2] - lower.rgb[2]) * t);

      return `rgb(${r}, ${g}, ${b})`;
    }

    function drawHeatmap(canvas, cityData) {
      const dates = cityData.dates;
      const times = cityData.times;
      const values = cityData.values;

      const rows = dates.length;
      const cols = times.length;
      if (!rows || !cols) return;

      const dpr = window.devicePixelRatio || 1;

      const displayWidth = canvas.clientWidth || 800;
      const displayHeight = canvas.clientHeight || 400;

      canvas.width = displayWidth * dpr;
      canvas.height = displayHeight * dpr;

      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      const cellW = displayWidth / cols;
      const cellH = displayHeight / rows;

      for (let r = 0; r < rows; r++) {
        const row = values[r];
        for (let c = 0; c < cols; c++) {
          const v = row[c] ?? 0;
          ctx.fillStyle = brightnessToColor(v);
          ctx.fillRect(c * cellW, r * cellH, cellW + 0.5, cellH + 0.5);
        }
      }

      // X축 시간 라벨
      ctx.font = "10px system-ui";
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";

      const labelHours = [0, 6, 12, 18, 24];
      labelHours.forEach((h) => {
        const idx = h * 2; // 30분 간격
        if (idx >= 0 && idx < cols) {
          const x = (idx + 0.5) * cellW;
          ctx.fillText(String(h).padStart(2, "0") + ":00", x, 4);
        }
      });

      // Y축: 월 시작 날짜
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "rgba(255,255,255,0.85)";

      for (let r = 0; r < rows; r++) {
        const dStr = dates[r];
        if (dStr.endsWith("-01")) {
          const y = (r + 0.5) * cellH;
          const [, month] = dStr.split("-");
          ctx.fillText(month + "월", 4, y);
        }
      }
    }

    // 컬러바 그리기
    function drawColorbar() {
      const canvas = document.getElementById("colorbar");
      const dpr = window.devicePixelRatio || 1;

      const displayWidth = canvas.clientWidth || 26;
      const displayHeight = canvas.clientHeight || 220;

      canvas.width = displayWidth * dpr;
      canvas.height = displayHeight * dpr;

      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      for (let y = 0; y < displayHeight; y++) {
        const v = 1 - y / displayHeight; // 위쪽이 1.0
        ctx.fillStyle = brightnessToColor(v);
        ctx.fillRect(0, y, displayWidth, 1);
      }
    }

    const cityButtonsContainer = document.getElementById("city-buttons");
    const miniMapsGrid = document.getElementById("mini-maps-grid");
    const mainCanvas = document.getElementById("main-heatmap");
    const mainTitle = document.getElementById("main-map-title");
    const tooltip = document.getElementById("heatmap-tooltip");

    const miniCanvases = {};
    let currentCityData = null; // hover용으로 현재 도시 데이터 저장

    // 버튼 생성
    CITY_ORDER.forEach((cityId) => {
      const data = window.BRIGHTNESS_DATA[cityId];
      if (!data) return;

      const btn = document.createElement("button");
      btn.className = "city-button";
      const label = CITY_LABELS[cityId] || data.city_name || cityId;
      btn.textContent = label;
      btn.dataset.cityId = cityId;

      btn.addEventListener("click", () => {
        showCity(cityId);
      });

      cityButtonsContainer.appendChild(btn);
    });

    // 미니 카드 생성
    CITY_ORDER.forEach((cityId) => {
      const data = window.BRIGHTNESS_DATA[cityId];
      if (!data) return;

      const card = document.createElement("div");
      card.className = "mini-card";
      card.dataset.cityId = cityId;

      const title = document.createElement("div");
      title.className = "mini-title";
      const label = CITY_LABELS[cityId] || data.city_name || cityId;
      title.textContent = label;

      const canvas = document.createElement("canvas");
      canvas.className = "mini-heatmap";

      card.appendChild(title);
      card.appendChild(canvas);
      miniMapsGrid.appendChild(card);

      miniCanvases[cityId] = { card, canvas };

      card.addEventListener("click", () => {
        showCity(cityId);
        scrollToMain();
      });
    });

    function updateButtonsActive(cityId) {
      document.querySelectorAll(".city-button").forEach((btn) => {
        if (btn.dataset.cityId === cityId) btn.classList.add("active");
        else btn.classList.remove("active");
      });
    }

    // 메인 히트맵 hover 설정(리스너는 한 번만 등록, 데이터만 교체)
    function setupMainHover() {
      mainCanvas.addEventListener("mousemove", (e) => {
        if (!currentCityData) {
          tooltip.style.opacity = 0;
          return;
        }

        const rect = mainCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const dates = currentCityData.dates;
        const times = currentCityData.times;
        const values = currentCityData.values;

        const rows = dates.length;
        const cols = times.length;

        const cellW = mainCanvas.clientWidth / cols;
        const cellH = mainCanvas.clientHeight / rows;

        const col = Math.floor(x / cellW);
        const row = Math.floor(y / cellH);

        if (col < 0 || col >= cols || row < 0 || row >= rows) {
          tooltip.style.opacity = 0;
          return;
        }

        const date = dates[row];
        const time = times[col];
        const value = values[row][col];

        tooltip.textContent =
`${date}  ${time}
Brightness: ${value.toFixed(3)}`;

        tooltip.style.left = e.clientX + 12 + "px";
        tooltip.style.top = e.clientY + 12 + "px";
        tooltip.style.opacity = 1;
      });

      mainCanvas.addEventListener("mouseleave", () => {
        tooltip.style.opacity = 0;
      });
    }

    function showCity(cityId) {
      const data = window.BRIGHTNESS_DATA[cityId];
      if (!data) return;

      currentCityData = data; // hover용 데이터 교체

      const label = CITY_LABELS[cityId] || data.city_name || cityId;
      mainTitle.textContent = `${label} — Twilight-inclusive Brightness (30-min)`;

      updateButtonsActive(cityId);

      drawHeatmap(mainCanvas, data);

      Object.entries(miniCanvases).forEach(([id, obj]) => {
        if (id === cityId) {
          obj.card.classList.add("hidden-mini");
        } else {
          obj.card.classList.remove("hidden-mini");
          drawHeatmap(obj.canvas, window.BRIGHTNESS_DATA[id]);
        }
      });

      drawColorbar();
    }

    function scrollToMain() {
      const sec = document.querySelector(".main-map-card");
      sec.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    const initialCity = window.BRIGHTNESS_DATA["new_york"]
      ? "new_york"
      : (window.BRIGHTNESS_DATA["seoul"] ? "seoul" : CITY_ORDER[0]);

    function refreshCurrent() {
      const activeBtn = document.querySelector(".city-button.active");
      const currentId = activeBtn
        ? activeBtn.dataset.cityId
        : initialCity;
      showCity(currentId);
    }

    window.addEventListener("load", () => {
      setupMainHover();
      drawColorbar();
      showCity(initialCity);
    });

    window.addEventListener("resize", refreshCurrent);
  </script>
</body>
</html>
